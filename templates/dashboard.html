<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
</head>
<body>
    {% include 'template.html' %}

    <div class="container mt-5">
        <h2>Welcome, {{ current_user.username }}!</h2>
        <p>Your Book Collection:</p>

        <div id="book-list" class="row mt-4">
            {% for book in books %}
                <div class="col-md-3 mb-4" id="book-{{ book.id }}" class="draggable" data-id="{{ book.id }}">
                    <div class="card">
                        <img src="{{ book.thumbnail }}" class="card-img-top" alt="Book Thumbnail">
                        <div class="card-body">
                            <h5 class="card-title">{{ book.title }}</h5>
                            <p class="card-text">Author: {{ book.author }}</p>
                            <p class="card-text">{{ book.description[:100] }}...</p>
                            {% if book.rating %}
                                <p class="card-text">Rating: {{ book.rating }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if books|length > 2 %}
            <button id="save-order" class="btn btn-primary mt-3">Save Book Order</button>
        {% endif %}

        <a href="{{ url_for('logout') }}" class="btn btn-danger mt-3">Logout</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Initialize sortable on the book list
        const bookList = document.getElementById('book-list');
        const sortable = new Sortable(bookList, {
            draggable: 'li',  // Draggable items are now li elements
            onEnd(evt) {
                // Get the updated order of book IDs from the sorted list
                const bookIds = Array.from(bookList.children).map(item => item.dataset.id);
                
                // Send the updated order to the backend
                fetch("{{ url_for('update_order') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ book_ids: bookIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Book order updated!');
                    } else {
                        alert('Failed to update book order.');
                    }
                });
            }
        });
    </script>    
</body>
</html>
